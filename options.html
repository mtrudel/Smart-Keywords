<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <link type="text/css" href="css/jquery-ui-1.8.14.custom.css" rel="stylesheet" />
    <link type="text/css" href="css/options.css" rel="stylesheet" />

    <script type="text/javascript" language="javascript" src="js/jquery.js"></script>
    <script type="text/javascript" language="javascript" src="js/jquery.dataTables.js"></script>
    <script type="text/javascript" language="javascript" src="js/jquery-ui-1.8.14.custom.min.js"></script>
    <script type="text/javascript" language="javascript" src="js/jquery.jeditable.mini.js"></script>
    <script type="text/javascript" language="javascript" src="js/underscore-min.js"></script>

    <script type="text/javascript" charset="utf-8">
      

      // // var mappings = JSON.parse(safari.extension.settings.mappings)
      // // var mappings = { foo: 'bar', woz: 'baz' }
      // var data = _(_(mappings).keys()).map( function(key) { return [key, mappings[key]] })

      $(document).ready(function() {
        safari.self.addEventListener("test", function( event ) {
          console.log("asdfasdf");
        }, false);

        $('#table').html( '<table cellpadding="0" cellspacing="0" border="0" class="display" id="mappings"></table>' );
        $('#mappings').dataTable( {
          "bLengthChange": false,
          "bPaginate": false,
          "bInfo": false,          
          "bFilter": false,
          "bJQueryUI": true,
          "aaData": data,
          "aoColumns": [
            { "sTitle": "Keyword", "bSortable": false, "sWidth": 200 },
            { "sTitle": "URL", "bSortable": false }
          ]
        } );

        makeEditable();
      })

      function makeEditable() {
        var table = $('#mappings').dataTable();
        $('td', table.fnGetNodes()).editable( function(value, settings) {
          return value
        },
        {
          "callback": function( sValue, y ) {
            var aPos = table.fnGetPosition( this );
            table.fnUpdate( sValue, aPos[0], aPos[1] );

            // Save the data back into the preference
            var newmap = {}
            $(table.fnGetNodes()).each( function() { 
              newmap[$(this).find('td:first').text()] = $(this).find('td:last').text()
            })
            safari.extension.settings.mappings = JSON.stringify(newmap)
          },
          "submitdata": function ( value, settings ) {
            return {
              "row_id": this.parentNode.getAttribute('id'),
              "column": table.fnGetPosition( this )[2]
            };
          },
          "height": "14px"
        });
      }

      function fnClickAddRow() {
        var table = $('#mappings').dataTable()
        var newRow = table.fnGetNodes(table.fnAddData( [ "keyword", "http://example.com/search?q=%s" ] )[0])
        makeEditable();
        
        $(newRow).find('td:first').text('').click()
      }

    </script>
  </head>
  <body>
    <h3>Smart Keywords Options</h3>
    <p>Here you can set the keywords you would like to define, and the URLs which are opened when you search on those keywords.</p>

    <a href="javascript:void(0);" onclick="fnClickAddRow();">Click to add a new row</a>
    <div id="table"/>
    <div>
  </body>
</html>
